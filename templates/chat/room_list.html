{% extends "base.html" %}

{% block title %}My Chats - StudyIt{% endblock %}

{% block content %}
<div style="max-width: 1000px; margin: 2rem auto;">
    <h1 style="color: #003057; margin-bottom: 2rem;">My Chats</h1>

    {% if messages %}
    {% for message in messages %}
    <div
        style="padding: 0.75rem; margin-bottom: 1rem; border-radius: 5px; {% if message.tags == 'error' %}background: #f8d7da; color: #721c24;{% elif message.tags == 'success' %}background: #d4edda; color: #155724;{% else %}background: #d1ecf1; color: #0c5460;{% endif %}">
        {{ message }}
    </div>
    {% endfor %}
    {% endif %}

    <!-- Pending Chat Requests Section -->
    {% if incoming_requests %}
    <div style="margin-bottom: 2rem;">
        <h2
            style="color: #003057; font-size: 1.25rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <span>ðŸ“¬ Pending Requests</span>
            <span
                style="background: #dc3545; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem; font-weight: bold;">
                {{ incoming_requests|length }}
            </span>
        </h2>
        <div style="background: white; padding: 1rem; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            {% for chat_request in incoming_requests %}
            <div
                style="border: 2px solid #ffc107; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; background: linear-gradient(to right, #fff9e6, white);">
                <div style="margin-bottom: 1rem;">
                    <h3 style="color: #003057; margin-bottom: 0.5rem; font-size: 1.125rem;">
                        {{ chat_request.sender.name }}
                        <span
                            style="background: #ffc107; color: #000; padding: 0.15rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem;">
                            NEW
                        </span>
                    </h3>
                    <p style="color: #666; margin-bottom: 0.5rem; font-size: 0.95rem;">
                        "{{ chat_request.message }}"
                    </p>
                    <p style="color: #999; font-size: 0.85rem;">
                        Sent {{ chat_request.created_at|timesince }} ago
                    </p>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <form method="post" action="{% url 'chat:accept_request' chat_request.id %}"
                        style="display: inline;" onsubmit="return handleAcceptRequest(event, this);">
                        {% csrf_token %}
                        <button type="submit"
                            style="background: #28a745; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 5px; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                            onmouseover="this.style.background='#218838'" onmouseout="this.style.background='#28a745'">
                            âœ“ Accept
                        </button>
                    </form>
                    <form method="post" action="{% url 'chat:reject_request' chat_request.id %}"
                        style="display: inline;" onsubmit="return handleRejectRequest(event, this);">
                        {% csrf_token %}
                        <button type="submit"
                            style="background: #dc3545; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 5px; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                            onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">
                            âœ• Decline
                        </button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Active Chats Section -->
    {% if chat_rooms %}
    <h2 style="color: #003057; font-size: 1.25rem; margin-bottom: 1rem;">ðŸ’¬ Active Chats</h2>
    {% endif %}

    {% if chat_rooms %}
    <div style="background: white; padding: 1rem; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        {% for room in chat_rooms %}
        <a href="{% url 'chat:room_detail' room.room_name %}"
            style="text-decoration: none; color: inherit; display: block;">
            <div style="border: 1px solid #eee; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; background: {% if room.unread_count > 0 %}#f0f8ff{% else %}#f8f9fa{% endif %}; transition: background 0.2s;"
                onmouseover="this.style.background='#e9ecef'"
                onmouseout="this.style.background='{% if room.unread_count > 0 %}#f0f8ff{% else %}#f8f9fa{% endif %}'">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <h3
                            style="color: #003057; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            {{ room.other_participant.name }}
                            {% if room.unread_count > 0 %}
                            <span
                                style="background: #dc3545; color: white; padding: 0.15rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: bold;">
                                {{ room.unread_count }} new
                            </span>
                            {% endif %}
                        </h3>
                        {% if room.last_message %}
                        <p style="color: #666; margin-bottom: 0.25rem; font-size: 0.9rem;">
                            <strong>{{ room.last_message.sender.name }}:</strong>
                            {{ room.last_message.content|truncatewords:20 }}
                        </p>
                        <p style="color: #999; font-size: 0.8rem;">
                            {{ room.last_message.timestamp|timesince }} ago
                        </p>
                        {% else %}
                        <p style="color: #999; font-style: italic; font-size: 0.9rem;">No messages yet</p>
                        {% endif %}
                    </div>
                    <div style="color: #003057; font-size: 1.5rem;">â†’</div>
                </div>
            </div>
        </a>
        {% endfor %}
    </div>
    {% else %}
    <div
        style="background: white; padding: 3rem; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center;">
        <p style="color: #666; font-size: 1.1rem; margin-bottom: 1rem;">You don't have any active chats yet.</p>
        <p style="color: #999; margin-bottom: 1.5rem;">Start a conversation by sending a chat request to another
            student!</p>
        <a href="{% url 'accounts:profile_list' %}"
            style="background: #003057; color: white; padding: 0.75rem 1.5rem; text-decoration: none; border-radius: 5px; font-weight: 500; display: inline-block;">
            Browse Students
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    function handleAcceptRequest(event, form) {
        event.preventDefault();
        event.stopPropagation();

        const formData = new FormData(form);
        const url = form.action;

        // Disable button
        const button = form.querySelector('button');
        button.disabled = true;
        button.textContent = 'Accepting...';

        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
            credentials: 'same-origin'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.room_name) {
                    // Redirect to chat room
                    window.location.href = `/chat/rooms/${data.room_name}/`;
                } else if (data.success) {
                    // Reload if no room name
                    window.location.reload();
                } else {
                    alert(data.error || 'Failed to accept request');
                    button.disabled = false;
                    button.textContent = 'âœ“ Accept';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to process request. Please try again.');
                button.disabled = false;
                button.textContent = 'âœ“ Accept';
            });

        return false;
    }

    function handleRejectRequest(event, form) {
        event.preventDefault();
        event.stopPropagation();

        const formData = new FormData(form);
        const url = form.action;

        // Disable button
        const button = form.querySelector('button');
        button.disabled = true;
        button.textContent = 'Declining...';

        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
            credentials: 'same-origin'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove the request card
                    const requestCard = form.closest('[style*="border: 2px solid #ffc107"]');
                    if (requestCard) {
                        requestCard.style.transition = 'all 0.3s ease-out';
                        requestCard.style.opacity = '0';
                        setTimeout(() => requestCard.remove(), 300);
                    }
                } else {
                    alert(data.error || 'Failed to reject request');
                    button.disabled = false;
                    button.textContent = 'âœ• Decline';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to process request. Please try again.');
                button.disabled = false;
                button.textContent = 'âœ• Decline';
            });

        return false;
    }
</script>
{% endblock %}